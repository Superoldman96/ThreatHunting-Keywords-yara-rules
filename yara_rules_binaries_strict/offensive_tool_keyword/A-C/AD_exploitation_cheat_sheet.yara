rule AD_exploitation_cheat_sheet
{
    meta:
        description = "Detection patterns for the tool 'AD exploitation cheat sheet' taken from the ThreatHunting-Keywords github project"
        author = "@mthcht"
        reference = "https://github.com/mthcht/ThreatHunting-Keywords"
        tool = "AD exploitation cheat sheet"
        rule_category = "offensive_tool_keyword"

    strings:
        // Description: Lateral Movement with Mimikatz  Overpass-the-hash a more opsec-safe version that uses the AES256 key (similar to with Rubeus above) - works for multiple Mimikatz commands
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string1 = /\s\/user\:.{0,100}\s\/domain\:.{0,100}\s\/aes256\:.{0,100}\s\/run\:powershell\.exe/ nocase ascii wide
        // Description: Lateral Movement with Mimikatz Overpass-the-hash (more risky than Rubeus writes to LSASS memory)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string2 = /\s\/user\:.{0,100}\s\/domain\:.{0,100}\s\/ntlm\:.{0,100}\s\/run\:powershell\.exe/ nocase ascii wide
        // Description: Lateral Movement with Mimikatz Golden ticket (domain admin w/ some ticket properties to avoid detection)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string3 = /\s\/user\:.{0,100}\s\/domain\:.{0,100}\s\/sid\:S\-1\-5\-21\-.{0,100}\s\/krbtgt\:.{0,100}\s\/id\:.{0,100}\s\/groups\:.{0,100}\s\/startoffset\:0\s\/endin\:600\s\/renewmax\:10080\s\/ptt/ nocase ascii wide
        // Description: DCShadow is an attack that masks certain actions by temporarily imitating a Domain Controller. If you have Domain Admin or Enterprise Admin privileges in a root domain it can be used for forest-level persistence.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string4 = /\s\-FakeDC\s.{0,100}\s\-SamAccountName\s.{0,100}\s\-Username\s/ nocase ascii wide
        // Description: Targeted kerberoasting by setting SPN
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string5 = /\s\-Identity\s.{0,100}\s\-Set\s\@\{serviceprincipalname\=\'.{0,100}\'\}/ nocase ascii wide
        // Description: Targeted kerberoasting we need ACL write permissions to set UserAccountControl flags for the target user. Using PowerView
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string6 = /\s\-Identity\s.{0,100}\s\-XOR\s\@\{useraccountcontrol\=4194304/ nocase ascii wide
        // Description: Dump LSASS memory through a process snapshot (-r) avoiding interacting with it directly
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string7 = /\slsass\.dmp/ nocase ascii wide
        // Description: Example command to relay the hash to authenticate as local admin (if the service account has these privileges) and run calc.exe. Omit the -c parameter to attempt a secretsdump instead.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string8 = /\s\-\-no\-http\-server\s\-smb2support\s\-t\s.{0,100}\s\-c\s/ nocase ascii wide
        // Description: Chisel proxying - On our attacking machine (Linux in this case) we start a Chisel server on port 80 in reverse SOCKS5 mode.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string9 = " server -p 80 --reverse --socks5"
        // Description: Chisel proxying - On our attacking machine (Linux in this case) we start a Chisel server on port 80 in reverse SOCKS5 mode.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string10 = /\.\/chisel\s/
        // Description: Lateral Movement with Rubeus  More stealthy variant but requires the AES256 key (see 'Dumping OS credentials with Mimikatz' section)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string11 = /\.exe\sasktgt\s\/user\:.{0,100}\s\/aes256\:.{0,100}\s\/opsec\s\/ptt/ nocase ascii wide
        // Description: Lateral Movement with Rubeus Pass the ticket to a sacrificial hidden process. allowing you to e.g. steal the token from this process (requires elevation)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string12 = /\.exe\sasktgt\s\/user\:.{0,100}\s\/rc4\:.{0,100}\s\/createnetonly\:.{0,100}cmd\.exe/ nocase ascii wide
        // Description: Lateral Movement with Rubeus  Request a TGT as the target user and pass it into the current session
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string13 = /\.exe\sasktgt\s\/user\:.{0,100}\s\/rc4\:.{0,100}\s\/ptt/ nocase ascii wide
        // Description: Chisel proxying - on our compromised target system we connect to this server and tell it to proxy all traffic over it via the reverse SOCKS5 tunnel.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string14 = /\.exe\sclient\s.{0,100}\:.{0,100}\sR\:socks/ nocase ascii wide
        // Description: Unconstrained delegation Exploitation with Rubeus
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string15 = /\.exe\sdump\s\/luid\:0x5379f2\s\/nowrap/ nocase ascii wide
        // Description: Unconstrained delegation  Exploitation with Rubeus
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string16 = /\.exe\smonitor\s\/interval\:5\s\/nowrap/ nocase ascii wide
        // Description: Unconstrained delegation  Exploitation with Rubeus
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string17 = /\.exe\sptt\s\/ticket\:/ nocase ascii wide
        // Description: Rubeus Use s4u2self and s4u2proxy to impersonate the DA user to the allowed SPN
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string18 = /\.exe\ss4u\s\/ticket\:.{0,100}\s\/impersonateuser\:.{0,100}\s\/msdsspn\:.{0,100}\s\/ptt/ nocase ascii wide
        // Description: Rubeus access the LDAP service on the DC (for dcsync)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string19 = /\.exe\ss4u\s\/user\:.{0,100}\s\/impersonateuser\:.{0,100}\s\/msdsspn\:.{0,100}\s\/altservice\:ldap\s\/ptt\s\/rc4/ nocase ascii wide
        // Description: Unconstrained delegation  Exploitation with Rubeus
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string20 = /\.exe\striage/ nocase ascii wide
        // Description: If you have low-privileged access to a MSSQL database and no links are present you could potentially force NTLM authentication by using the xp_dirtree stored procedure to access this share. If this is successful  the NetNTLM for the SQL service account can be collected and potentially cracked or relayed to compromise machines as that service account.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string21 = /\.xp_dirtree\s.{0,100}\\/ nocase ascii wide
        // Description: Crack the hash with Hashcat
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string22 = /\/rockyou\.txt/
        // Description: Crack with TGSRepCrack
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string23 = /10k\-worst\-pass\.txt/ nocase ascii wide
        // Description: Using DAMP toolkit We add the backdoor using the Add-RemoteRegBackdoor.ps1 cmdlet from DAMP.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string24 = "Add-RemoteRegBackdoor" nocase ascii wide
        // Description: PowerShell AMSI Bypass
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string25 = /Assembly\.GetType\(\'System\.Management\.Automation\.AmsiUtils\'\)\.GetField\(\'amsiInitFailed\'.{0,100}\'NonPublic.{0,100}Static\'\)\.SetValue\(\$null.{0,100}\$true\)/ nocase ascii wide
        // Description: Chisel proxying - on our compromised target system we connect to this server and tell it to proxy all traffic over it via the reverse SOCKS5 tunnel.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string26 = /chisel\.exe\s/ nocase ascii wide
        // Description: Dumping secrets from a Volume Shadow Copy We can also create a Volume Shadow Copy of the SAM and SYSTEM files (which are always locked on the current system) so we can still copy them over to our local system. An elevated prompt is required for this.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string27 = /copy\s\\.{0,100}\\HarddiskVolumeShadowCopy1\\windows\\system32\\config\\sam\sC\:\\/ nocase ascii wide
        // Description: Dumping secrets from a Volume Shadow Copy We can also create a Volume Shadow Copy of the SAM and SYSTEM files (which are always locked on the current system) so we can still copy them over to our local system. An elevated prompt is required for this.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string28 = /copy\s\\.{0,100}\\HarddiskVolumeShadowCopy1\\windows\\system32\\config\\system\sC\:\\/ nocase ascii wide
        // Description: Generate EncodedCommand
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string29 = /echo\s\-n\s\'cmd\s\/c\sstart\srundll32\s.{0,100}\.dll.{0,100}\s\|\sbase64/ nocase ascii wide
        // Description: Lateral Movement Enumeration With PowerView
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string30 = "Find-InterestingDomainAcl" nocase ascii wide
        // Description: Lateral Movement Enumeration With PowerView
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string31 = "Find-LocalAdminAccess" nocase ascii wide
        // Description: AS-REP roasting Get the hash for a roastable user using ASREPRoast.ps1
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string32 = "Get-ASREPHash" nocase ascii wide
        // Description: msds-allowedtodelegateto*
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string33 = /Get\-DomainComputer\s\-TrustedToAuth\s\|\sselect\sname/ nocase ascii wide
        // Description: Abusing inter-forest trust Powersploit
        // Reference: https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainForeignGroupMember/
        $string34 = "Get-DomainForeignGroupMember" nocase ascii wide
        // Description: msds-allowedtodelegateto*
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string35 = /Get\-DomainUser\s\-TrustedToAuth\s\|\sselect\suserprincipalname/ nocase ascii wide
        // Description: TightVNC password (convert to Hex then decrypt with e.g.: https://github.com/frizb/PasswordDecrypts)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string36 = /Get\-ItemProperty\s\-Path\sHKLM\:\\Software\\TightVNC\\Server\s\-Name\s.{0,100}Password.{0,100}\s\|\sselect\s\-ExpandProperty\sPassword/ nocase ascii wide
        // Description: Sometimes LSASS is configured to run as a protected process (PPL). You can query this with PowerShell as follows.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string37 = /Get\-ItemProperty\s\-Path\sHKLM\:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\s\-Name\s.{0,100}RunAsPPL/ nocase ascii wide
        // Description: Get cached credentials (if any)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string38 = "Get-RemoteCachedCredential" nocase ascii wide
        // Description: Get local account hashes
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string39 = "Get-RemoteLocalAccountHash" nocase ascii wide
        // Description: Get machine account hash for silver ticket attack
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string40 = "Get-RemoteMachineAccountHash" nocase ascii wide
        // Description: Automatically find all linked databases
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string41 = "Get-SqlServerLinkCrawl" nocase ascii wide
        // Description: Command execution with WMI From Linux
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string42 = "impacket-wmiexec"
        // Description: Token Manipulation Tokens can be impersonated from other users with a session/running processes on the machine. Most C2 frameworks have functionality for this built-in (such as the Steal Token functionality in Cobalt Strike)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string43 = /incognito.{0,100}\slist_tokens\s\-u/ nocase ascii wide
        // Description: Token Manipulation Tokens can be impersonated from other users with a session/running processes on the machine. Most C2 frameworks have functionality for this built-in (such as the Steal Token functionality in Cobalt Strike)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string44 = /incognito\.exe/ nocase ascii wide
        // Description: Check for vulnerable programs and configs
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string45 = "Invoke-AllChecks" nocase ascii wide
        // Description: Exploit vulnerable service permissions (does not require touching disk)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string46 = "Invoke-ServiceAbuse" nocase ascii wide
        // Description: Scan for MSSQL misconfigurations to escalate to System Admin
        // Reference: https://stealthbits.com/blog/compromise-powerupsql-sql-attacks/
        $string47 = "Invoke-SQLAudit" nocase ascii wide
        // Description: Run command (enables XP_CMDSHELL automatically if required)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string48 = /Invoke\-SQLOSCmd\s\-Instance\s.{0,100}\s\-Command\s/ nocase ascii wide
        // Description: Invoke-TokenManipulation script Tokens can be impersonated from other users with a session/running processes on the machine. Most C2 frameworks have functionality for this built-in (such as the Steal Token functionality in Cobalt Strike)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string49 = "Invoke-TokenManipulation" nocase ascii wide
        // Description: Dump LSASS memory through a process snapshot (-r) avoiding interacting with it directly
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string50 = /lsass\.dmp/ nocase ascii wide
        // Description: Unconstrained delegation From attacking machine entice the Domain Controller to connect using the printer bug. Binary from here https://github.com/leechristensen/SpoolSample
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string51 = /MS\-RPRN\.exe\s/ nocase ascii wide
        // Description: Crack with TGSRepCrack
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string52 = /mssqlsvc\.kirbi/ nocase ascii wide
        // Description: Example command to relay the hash to authenticate as local admin (if the service account has these privileges) and run calc.exe. Omit the -c parameter to attempt a secretsdump instead.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string53 = "ntlmrelayx --" nocase ascii wide
        // Description: Dump LSASS memory through a process snapshot (-r) avoiding interacting with it directly
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string54 = /procdump\.exe.{0,100}lsass/ nocase ascii wide
        // Description: Crack the hash with Hashcat
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string55 = /pwd.{0,100}\/.{0,100}\/rules\/best64\.rule/ nocase ascii wide
        // Description: DCShadow is an attack that masks certain actions by temporarily imitating a Domain Controller. If you have Domain Admin or Enterprise Admin privileges in a root domain it can be used for forest-level persistence.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string56 = "Set-DCShadowPermissions" nocase ascii wide
        // Description: Targeted kerberoasting by setting SPN
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string57 = "Set-DomainObject" nocase ascii wide
        // Description: PowerShell AMSI Bypass Obfuscation example for copy-paste purposes
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string58 = /sET\-ItEM\s\(\s\'V\'\+\'aR\'\s\+\s\s\'IA\'\s\+\s\'blE\:1q2\'\s\s\+\s\'uZx\'/ nocase ascii wide
        // Description: Use SharpBypassUAC e.g. from a CobaltStrike beacon
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string59 = "SharpBypassUAC" nocase ascii wide
        // Description: Crack with TGSRepCrack
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string60 = /tgsrepcrack\./ nocase ascii wide
        // Description: Start new process with token of a specific user. Tokens can be impersonated from other users with a session/running processes on the machine. Most C2 frameworks have functionality for this built-in (such as the Steal Token functionality in Cobalt Strike)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string61 = /token.{0,100}\s\-CreateProcess\s.{0,100}\s\-ProcessId\s/ nocase ascii wide
        // Description: Start new process with token of a specific user. Tokens can be impersonated from other users with a session/running processes on the machine. Most C2 frameworks have functionality for this built-in (such as the Steal Token functionality in Cobalt Strike)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string62 = /token.{0,100}\s\-ImpersonateUser\s\-Username\s/ nocase ascii wide
        // Description: Token Manipulation Tokens can be impersonated from other users with a session/running processes on the machine. Most C2 frameworks have functionality for this built-in (such as the Steal Token functionality in Cobalt Strike)
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string63 = "use incognito" nocase ascii wide
        // Description: Dumping secrets from a Volume Shadow Copy We can also create a Volume Shadow Copy of the SAM and SYSTEM files (which are always locked on the current system) so we can still copy them over to our local system. An elevated prompt is required for this.
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string64 = /wmic\sshadowcopy\scall\screate\sVolume\=\'C\:\\\'/ nocase ascii wide
        // Description: Exploit an unquoted service path vulnerability to spawn a beacon
        // Reference: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference
        $string65 = "Write-ServiceBinary" nocase ascii wide
        $metadata_regex_import = /\bimport\s+[a-zA-Z0-9_.]+\b/ nocase
        $metadata_regex_function = /function\s+[a-zA-Z_][a-zA-Z0-9_]*\(/ nocase ascii
        $metadata_regex_php = /<\?php/ nocase ascii
        $metadata_regex_createobject = /(CreateObject|WScript\.)/ nocase ascii
        $metadata_regex_script = /<script\b/ nocase ascii
        $metadata_regex_javascript = /(let\s|const\s|function\s|document\.|console\.)/ nocase ascii
        $metadata_regex_powershell = /(Write-Host|Get-[a-zA-Z]+|Invoke-|param\(|\.SYNOPSIS)/ nocase ascii
        $metadata_regex_batch = /@(echo\s|call\s|set\s|goto\s|if\s|for\s|rem\s)/ nocase ascii
        $metadata_regex_shebang = /^#!\// nocase ascii

    condition:
        ((filesize < 20MB and (
            uint16(0) == 0x5a4d or // Windows binary
            uint16(0) == 0x457f or // Linux ELF
            uint32be(0) == 0x7f454c46 or uint16(0) == 0xfeca or uint16(0) == 0xfacf or uint32(0) == 0xbebafeca or // macOS binary
            uint32(0) == 0x504B0304 or // Android APK, JAR
            uint32(0) == 0xCAFEBABE or // Java Class, Mach-O Universal Binary
            uint32(0) == 0x4D534346 or // Windows Cabinet File
            uint32(0) == 0xD0CF11E0 or // MSI Installer Package
            uint16(0) == 0x2321 or // Shebang (#!)
            uint16(0) == 0x3c3f // PHP and other script
        )) and 2 of ($string*)) or
        (filesize < 2MB and
        (
            2 of ($string*) and
            for any of ($metadata_regex_*) : ( @ <= 20000 )
        ))
}
